name: hl-repo Update Action
on: [push, pull_request]

jobs:
  
  check-repo-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v2
      ## Step only reqired for private submodules

  build-pkg:
    runs-on: ubuntu-latest
    container: archlinux:latest

    needs: ["check-repo-updates"]
    
    steps:
      - name: Install Git
        run: pacman -Syu --noconfirm git

      - name: Submodule Checkout
        uses: jwsi/submodule-checkout@v1

      - name: Prepare for makepkg
        run: |
          pacman -Syu --noconfirm base-devel sudo
          useradd user -G wheel && echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown user -R ..
          chown user -R /tmp

      - name: Build Packages
        env:
          PKGDEST: "/tmp/pkgs"
        uses: 2m/arch-pkgbuild-builder@v1.16
        with:
          target: 'pkgbuild'
  
  make-release: 
    runs-on: ubuntu-latest

    needs: [check-repo-updates, "build-pkg"]
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v3
        with:
          path: ${{ env.PKGDEST }}

      - name: Make new release
        uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          files: |
            ${{ env.PKGDEST }}/kernel-packages-*/*
